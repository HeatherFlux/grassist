<!doctype html>
<html>
  <head>
    <title>Grassist: the autonomous lawnmower</title>
    <script type="text/javascript" src="../lib/init.js"></script>
    <script type="text/javascript" src="../lib/lawnmower.js"></script>
    <script type="text/javascript" src="../lib/planner.js"></script>
    <script type="text/javascript" src="../lib/yard.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
      svg {
        display: block;
        margin: 0 auto;
      }
      path {
        stroke: lightgray;
        fill: none;
        stroke-width: 5px;
      }
      .cut {
        fill: gray;
      }
      .not-cut {
        stroke: gray;
        stroke-width: 2px;
        fill: none;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      var patches = [
        " !!!!!!!!!! ",
        "   %%%!!!!!!",
        "   %X%!!!%!!",
        "   %%%%%%X%!",
        "   %X%!!!%!!",
        "   %%%!!!!!!",
        " !!!!!!!!!! "
      ];
      var yard = GRASSIST.yard(patches, 0, 3);
      var mower = GRASSIST.lawnmower();
      var planner = GRASSIST.planner();
      mower.onUpdate(yard.processLawnmower);

      var patchSize = 100;
      var yardBounds = yard.bounds();
      var yardWidth = 1 + yardBounds[2] - yardBounds[0];
      var yardHeight = 1 + yardBounds[3] - yardBounds[1];
      var svg = d3.select('body').append('svg')
        .attr('width', patchSize * yardWidth)
        .attr('height', patchSize * yardHeight);

      var updates = [];
      var xScale = d3.scale.linear().domain([yardBounds[0], yardBounds[2]]).range([patchSize * 0.5, patchSize * (yardWidth - 0.5)]);
      var yScale = d3.scale.linear().domain([yardBounds[1], yardBounds[3]]).range([patchSize * (yardHeight - 0.5), patchSize * 0.5]);
      var classScale = d3.scale.ordinal().domain([true, false]).range(['cut', 'not-cut']);
      var radius = patchSize * 0.25;

      var line = d3.svg.line()
        .x(function(d) { return xScale(d.longitude); })
        .y(function(d) { return yScale(d.latitude); });
      svg.append('path').attr('d', '');
      var visitGroup = svg.append('g');

      mower.onUpdate(function(longitude, latitude, rotorEnabled) {
        updates.push({
          longitude: longitude,
          latitude: latitude,
          rotorEnabled: rotorEnabled
        });

        svg.select('path')
          .attr('d', line(updates));

        var visits = visitGroup.selectAll('circle').data(updates);
        visits.enter()
          .append('circle')
          .attr('cx', function(d) { return xScale(d.longitude); })
          .attr('cy', function(d) { return yScale(d.latitude); })
          .attr('class', function(d) { return classScale(d.rotorEnabled); })
          .attr('r', radius);
      });
      planner.plan(mower, yard);
    </script>
  </body>
</html>
