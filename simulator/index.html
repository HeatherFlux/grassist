<!doctype html>
<html>
  <head>
    <title>Grassist: the autonomous lawnmower</title>
    <script type="text/javascript" src="../lib/init.js"></script>
    <script type="text/javascript" src="../lib/lawnmower.js"></script>
    <script type="text/javascript" src="../lib/planner.js"></script>
    <script type="text/javascript" src="../lib/yard.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
      svg {
        display: block;
        margin: 0 auto;
      }
      .path {
        stroke: lightgray;
        fill: none;
        stroke-width: 5px;
      }
      .cut {
        fill: gray;
      }
      .not-cut {
        stroke: gray;
        stroke-width: 2px;
        fill: none;
      }
      .lawnmower-heading {
        fill: white;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      var patches = [
        " !!!!!!!!!! ",
        "   %%%!!!!!!",
        "   %X%!!!%!!",
        "   %%%%%%X%!",
        "   %X%!!!%!!",
        "   %%%!!!!!!",
        " !!!!!!!!!! "
      ];
      var yard = GRASSIST.yard(patches, 0, 3);
      var mower = GRASSIST.lawnmower();
      var planner = GRASSIST.planner();
      mower.onUpdate(yard.processLawnmower);

      var patchSize = 100;
      var yardBounds = yard.bounds();
      var yardWidth = 1 + yardBounds[2] - yardBounds[0];
      var yardHeight = 1 + yardBounds[3] - yardBounds[1];

      var updates = [];
      var xScale = d3.scale.linear().domain([yardBounds[0], yardBounds[2]]).range([patchSize * 0.5, patchSize * (yardWidth - 0.5)]);
      var yScale = d3.scale.linear().domain([yardBounds[1], yardBounds[3]]).range([patchSize * (yardHeight - 0.5), patchSize * 0.5]);
      var visitClassScale = d3.scale.ordinal().domain([true, false]).range(['cut', 'not-cut']);
      var rotorEnabledScale = d3.scale.ordinal().domain([true, false]).range(['#f03', '#969']);
      var headingScale = d3.scale.ordinal().domain(['east', 'north', 'west', 'south']).range([0, -90, -180, -270]);
      var radius = patchSize * 0.25;

      var line = d3.svg.line()
        .x(function(d) { return xScale(d.longitude); })
        .y(function(d) { return yScale(d.latitude); });

      var svg = d3.select('body').append('svg')
        .attr('width', patchSize * yardWidth)
        .attr('height', patchSize * yardHeight);
      svg.append('path')
        .attr('class', 'path')
        .attr('d', '');
      svg.append('g')
        .attr('class', 'visits');
      var mowerGroup = svg.append('g')
        .attr('class', 'lawnmower')
        .attr('transform', 'translate(' + xScale(0) + ', ' + yScale(0) + ')');
      mowerGroup.append('circle')
        .attr('class', 'lawnmower-body')
        .style('fill', rotorEnabledScale(false))
        .attr('r', radius * 1.5);
      mowerGroup.append('polygon')
        .attr('class', 'lawnmower-heading')
        .attr('points', '0,' + (radius/2) + ' 0,' + (-radius/2) + ' ' + radius + ',0')
        .attr('transform', 'rotate(' + headingScale(0) + ')');

      var transition = svg.transition();

      mower.onUpdate(function(mower) {
        var position = mower.position();
        var longitude = position[0];
        var latitude = position[1];
        updates.push({
          longitude: longitude,
          latitude: latitude,
          rotorEnabled: mower.rotorEnabled()
        });

        svg.select('.visits').selectAll('circle').data(updates)
          .enter()
          .append('circle');
        var lineData = line(updates);

        transition = transition.transition();

        transition.select('.lawnmower')
          .attr('transform', 'translate(' + xScale(longitude) + ', ' + yScale(latitude) + ')');
        transition.select('.lawnmower-body')
          .style('fill', rotorEnabledScale(mower.rotorEnabled()));
        transition.select('.lawnmower-heading')
          .attr('transform', 'rotate(' + headingScale(mower.heading()) + ')');
        transition.select('.path')
          .attr('d', lineData)
          .each('end', function() {
            svg.select('.path')
              .attr('d', lineData + 'L' + xScale(longitude) + ',' + yScale(latitude));
          });

        transition.transition().select('.visits').selectAll('circle')
          .attr('cx', function(d) { return xScale(d.longitude); })
          .attr('cy', function(d) { return yScale(d.latitude); })
          .attr('class', function(d) { return visitClassScale(d.rotorEnabled); })
          .attr('r', radius);
      });
      planner.plan(mower, yard);
    </script>
  </body>
</html>
