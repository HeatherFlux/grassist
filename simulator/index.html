<!doctype html>
<html>
  <head>
    <title>Grassist: the autonomous lawnmower</title>
    <script type="text/javascript" src="../lib/init.js"></script>
    <script type="text/javascript" src="../lib/lawnmower.js"></script>
    <script type="text/javascript" src="../lib/planner.js"></script>
    <script type="text/javascript" src="../lib/yard.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style type="text/css">
      svg {
        display: block;
        margin: 0 auto;
      }
      .path {
        stroke: #d24;
        stroke-dasharray: 0.25 12.25;
        stroke-dashoffset: 0;
        stroke-linecap: round;
        opacity: 0.75;
        fill: none;
        stroke-width: 6px;
      }
      .lawnmower-heading {
        fill: white;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      var patches = [
        " !!!!!!!!!! ",
        "   %%%!!!!!!",
        "   %X%!!!%!!",
        "   %%%%%%X%!",
        "   %X%!!!%!!",
        "   %%%!!!!!!",
        " !!!!!!!!!! "
      ];
      var startLongitude = 0;
      var startLatitude = 3;
      var yard = GRASSIST.yard(patches, startLongitude, startLatitude);
      var mower = GRASSIST.lawnmower();
      var planner = GRASSIST.planner();
      mower.onUpdate(yard.processLawnmower);

      var patchSize = 100;
      var yardBounds = yard.bounds();
      var yardWidth = 1 + yardBounds[2] - yardBounds[0];
      var yardHeight = 1 + yardBounds[3] - yardBounds[1];

      var updates = [];
      var xScale = d3.scale.linear().domain([yardBounds[0], yardBounds[2]]).range([patchSize * 0.5, patchSize * (yardWidth - 0.5)]);
      var yScale = d3.scale.linear().domain([yardBounds[1], yardBounds[3]]).range([patchSize * (yardHeight - 0.5), patchSize * 0.5]);
      var rotorEnabledScale = d3.scale.ordinal()
        .domain([true, false])
        .range(['#d24', '#835']);
      var patchTypeScale = d3.scale.ordinal()
        .domain(['long_grass', 'short_grass', 'sidewalk', 'mulch_gravel', 'plant_flower'])
        .range(['#9d4', '#cd7', '#ba9', '#983', '#372']);
      var headingScale = d3.scale.ordinal().domain(['east', 'north', 'west', 'south']).range([0, -90, -180, -270]);
      var radius = patchSize * 0.25;

      var line = d3.svg.line()
        .x(function(d) { return xScale(d.longitude); })
        .y(function(d) { return yScale(d.latitude); });

      var svg = d3.select('body').append('svg')
        .attr('width', patchSize * yardWidth)
        .attr('height', patchSize * yardHeight);
      var yardGroup = svg.append('g')
        .attr('class', 'yard');
      svg.append('path')
        .attr('class', 'path')
        .attr('d', '');
      var mowerGroup = svg.append('g')
        .attr('class', 'lawnmower')
        .attr('transform', 'translate(' + xScale(0) + ', ' + yScale(0) + ')');
      mowerGroup.append('circle')
        .attr('class', 'lawnmower-body')
        .style('fill', rotorEnabledScale(false))
        .attr('r', radius * 1.5);
      mowerGroup.append('polygon')
        .attr('class', 'lawnmower-heading')
        .attr('points', '0,' + (radius/2) + ' 0,' + (-radius/2) + ' ' + radius + ',0')
        .attr('transform', 'rotate(' + headingScale(0) + ')');

      var yardTiles = [];
      var updateTile = function(longitude, latitude) {
        yardTiles[longitude + (yardHeight - latitude - 1) * yardWidth] = yard.patchType(longitude - startLongitude, latitude - startLatitude);
      };
      for (var latitude = yardHeight - 1; latitude >= 0; latitude--) {
        for (var longitude = 0; longitude < yardWidth; longitude++) {
          updateTile(longitude, latitude);
        }
      }
      yardGroup.selectAll('.tile').data(yardTiles)
        .enter()
        .append('rect')
        .attr('class', 'tile')
        .attr('fill', patchTypeScale)
        .attr('x', function(d, i) { return patchSize * (i % yardWidth) })
        .attr('y', function(d, i) { return patchSize * Math.floor(i / yardWidth) })
        .attr('width', patchSize)
        .attr('height', patchSize);

      var transition = svg.transition();

      mower.onUpdate(function(mower) {
        var position = mower.position();
        var longitude = position[0];
        var latitude = position[1];
        updates.push({
          longitude: longitude,
          latitude: latitude,
          rotorEnabled: mower.rotorEnabled()
        });

        var lineData = line(updates);

        transition = transition.transition();

        transition.select('.yard').select('.tile:nth-child(' + (1 + (longitude + startLongitude) + (yardHeight - 1 - (latitude + startLatitude)) * yardWidth) + ')')
          .attr('fill', patchTypeScale(yard.patchType(longitude, latitude)));
        transition.select('.lawnmower')
          .attr('transform', 'translate(' + xScale(longitude) + ', ' + yScale(latitude) + ')');
        transition.select('.lawnmower-body')
          .style('fill', rotorEnabledScale(mower.rotorEnabled()));
        transition.select('.lawnmower-heading')
          .attr('transform', 'rotate(' + headingScale(mower.heading()) + ')');
        transition.select('.path')
          .attr('d', lineData)
          .each('end', function() {
            svg.select('.path')
              .attr('d', lineData + 'L' + xScale(longitude) + ',' + yScale(latitude));
          });
      });
      planner.plan(mower, yard);
    </script>
  </body>
</html>
